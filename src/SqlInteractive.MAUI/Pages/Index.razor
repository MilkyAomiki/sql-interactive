@page "/"
@using Microsoft.Extensions.Logging
@using SqlInteractive.BLL.Models
@using SqlInteractive.MAUI.Data
@inject SqlExecutionService sqlExecutionService
@inject ILogger<Index> Logger


<h1>SQL</h1>

<div class="form-group">
  <label for="queryInput" class="sr-only">Entery your query</label>
  <pre><code  class="form-control" id="queryInput" rows="5"  @bind="SqlQuery"> </code></pre>
</div>

<button type="submit" class="btn btn-primary" @onclick="HandleExecute">Execute</button>

@if(Tables is not null)
{
    <div>
        @foreach (var table in Tables)
        {
            <table>
                <caption>@table.Name</caption>
                <thead>
                    <tr>
                        @foreach (var fieldName in table.ColumnNames)
                        {
                            <th>@fieldName</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var row in table.Rows)
                    {
                        <tr>
                            @foreach (var col in row)
                            {
                                <td>@col</td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
}

@if(SqlException is not null)
{
    <p>@SqlException</p>
}

@code {
    private string SqlQuery;
    private ICollection<Table> Tables;
    private string SqlException;

    private async Task HandleExecute()
    {
        Tables = null;
        SqlException = null;

        Logger.LogInformation("Submitted query is: {query}", SqlQuery);

        var execResult = await sqlExecutionService.ExecuteSql(SqlQuery);
        Tables = execResult.Tables;
        SqlException = execResult.Exception;
    }
}